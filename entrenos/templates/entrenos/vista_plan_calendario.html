<!-- templates/entrenos/vista_plan_calendario.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Calendario de Entrenamiento - {{ cliente.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* === BASE Y FONDOS === */
    body {
        background: url("{% static 'images/fondo_cyberpunk.png' %}" ) no-repeat center center fixed !important;
        background-size: cover !important;
        background-color: #000000 !important;
        min-height: 100vh !important;
        filter: brightness(0.9);
    }
    .page-wrapper {
        width: 100%;
        overflow-x: hidden;
    }
    body.modal-open {
        overflow: inherit !important;
        padding-right: 0 !important;
    }
    .blade-runner-atmosphere {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
    }
    .background-fog {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 30% 20%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 70% 80%, rgba(255, 0, 255, 0.1) 0%, transparent 50%);
    }

    /* === CONTENEDOR DEL CALENDARIO (MINIMALISTA) === */
    .cyber-calendar-container {
        background: transparent !important;
        backdrop-filter: none !important;
        border: none !important;
        box-shadow: none !important;
        padding: 1rem;
        margin: 1rem auto;
        max-width: 900px;
    }

    /* === HEADER DEL CALENDARIO === */
    .cyber-calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .cyber-calendar-header h3 {
        font-size: 1.8rem;
        font-weight: 600;
        color: #e5e7eb;
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        margin: 0;
        text-align: center;
        flex: 1;
    }
    .cyber-nav-btn {
        background: rgba(30, 30, 30, 0.7) !important;
        border: 1px solid rgba(77, 208, 225, 0.4) !important;
        color: #e5e7eb !important;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .cyber-nav-btn:hover {
        background: rgba(40, 40, 40, 0.9) !important;
        border-color: rgba(77, 208, 225, 0.7) !important;
        color: #ffffff !important;
    }

    /* === GRID Y CELDAS DEL CALENDARIO === */
    .cyber-calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
    }
    .cyber-calendar-day-header {
        text-align: center;
        font-weight: 600;
        color: #00ffff;
        padding-bottom: 1rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        text-shadow: 0 0 5px rgba(0, 255, 255, 0.7);
    }
    .cyber-calendar-day {
        aspect-ratio: 1 / 1;
        border-radius: 16px;
        background: rgba(10, 23, 36, 0.6);
        border: 1px solid rgba(77, 208, 225, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: rgba(229, 231, 235, 0.7);
        transition: all 0.3s ease;
    }
    .cyber-calendar-day.has-training { cursor: pointer; }
    .cyber-calendar-day.has-training:hover {
        background: rgba(10, 23, 36, 0.9);
        border-color: rgba(77, 208, 225, 0.6);
    }
    .cyber-calendar-day.empty {
        background: transparent;
        border-color: transparent;
        cursor: default;
    }

    /* === ESTILOS DE ESTADO Y FASE === */
    .cyber-calendar-day.today {
        border: 2px solid #00ffff;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        color: #00ffff;
    }
    .cyber-calendar-day.text-fase-acumulacion { color: #00aeff; text-shadow: 0 0 8px rgba(0, 174, 255, 0.7); }
    .cyber-calendar-day.text-fase-fuerza { color: #ff4da6; text-shadow: 0 0 8px rgba(255, 77, 166, 0.7); }
    .cyber-calendar-day.text-fase-potencia { color: #ffc400; text-shadow: 0 0 8px rgba(255, 196, 0, 0.7); }
    .cyber-calendar-day.text-fase-descarga { color: #00ff64; text-shadow: 0 0 8px rgba(0, 255, 100, 0.7); }

    /* === NUEVO: ESTILOS PARA LA LEYENDA DE COLORES === */
    .cyber-legend-container {
        max-width: 900px;
        margin: 0 auto 2rem auto;
        padding: 1rem;
        background: rgba(10, 23, 36, 0.6);
        border: 1px solid rgba(77, 208, 225, 0.2);
        border-radius: 16px;
    }
    .cyber-legend-list {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    .cyber-legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: rgba(229, 231, 235, 0.8);
    }
    .legend-color-box {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }
    .bg-fase-acumulacion { background-color: #00aeff; box-shadow: 0 0 8px rgba(0, 174, 255, 0.7); }
    .bg-fase-fuerza { background-color: #ff4da6; box-shadow: 0 0 8px rgba(255, 77, 166, 0.7); }
    .bg-fase-potencia { background-color: #ffc400; box-shadow: 0 0 8px rgba(255, 196, 0, 0.7); }
    .bg-fase-descarga { background-color: #00ff64; box-shadow: 0 0 8px rgba(0, 255, 100, 0.7); }

    /* === ESTILOS DEL MODAL === */
    .cyber-modal .modal-content {
        background: #121212 !important;
        border: 1px solid rgba(0, 255, 255, 0.6) !important;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.4) !important;
        border-radius: 15px;
        color: #ffffff;
    }
    .cyber-modal .modal-body { padding: 0 !important; }
    .cyber-modal .modal-body table { border-radius: 15px 15px 0 0; overflow: hidden; }
    .cyber-modal .modal-footer {
        background: #121212 !important;
        border-top: 1px solid #343a40;
        border-radius: 0 0 15px 15px;
        display: flex;
        gap: 1rem;
    }
    .cyber-btn-secondary, .cyber-btn-success {
        flex: 1;
        text-align: center;
        justify-content: center;
    }
</style>
{% endblock %}
{% block content %}
<div class="page-wrapper">
    {% if not validacion_fallida %}
    <div class="blade-runner-atmosphere">
        <div class="background-fog"></div>
    </div>

    <div class="container">

        <!-- LEYENDA DE COLORES -->
        <div class="cyber-legend-container">
            <div class="cyber-legend-list">
                <div class="cyber-legend-item">
                    <div class="legend-color-box bg-fase-acumulacion"></div>
                    <span>Hipertrofia</span>
                </div>
                <div class="cyber-legend-item">
                    <div class="legend-color-box bg-fase-fuerza"></div>
                    <span>Fuerza</span>
                </div>
                <div class="cyber-legend-item">
                    <div class="legend-color-box bg-fase-potencia"></div>
                    <span>Potencia</span>
                </div>
                <div class="cyber-legend-item">
                    <div class="legend-color-box bg-fase-descarga"></div>
                    <span>Descarga</span>
                </div>
            </div>
        </div>

        <div class="cyber-calendar-container">
            <!-- Header del calendario -->
            <div class="cyber-calendar-header">
                <a href="?año={{ nav.anterior.año }}&mes={{ nav.anterior.mes }}" class="cyber-nav-btn">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <h3><i class="fas fa-calendar-alt me-2"></i>{{ calendario.nombre_mes }} {{ calendario.año }}</h3>
                <a href="?año={{ nav.siguiente.año }}&mes={{ nav.siguiente.mes }}" class="cyber-nav-btn">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </div>

            <!-- Grid del calendario -->
            <div class="cyber-calendar-grid">
                <div class="cyber-calendar-day-header">L</div>
                <div class="cyber-calendar-day-header">M</div>
                <div class="cyber-calendar-day-header">X</div>
                <div class="cyber-calendar-day-header">J</div>
                <div class="cyber-calendar-day-header">V</div>
                <div class="cyber-calendar-day-header">S</div>
                <div class="cyber-calendar-day-header">D</div>

                <!-- Días del mes con la lógica corregida -->
                {% for semana in calendario.semanas %}
                {% for dia in semana %}
                {% if dia %}
                <div class="cyber-calendar-day
                             {% if dia.es_hoy %}today{% endif %}
                             {% if dia.entrenamiento %}
                                 has-training
                                 {% if 'hipertrofia' in dia.entrenamiento.fase_css %}text-fase-acumulacion{% endif %}
                                 {% if 'fuerza' in dia.entrenamiento.fase_css %}text-fase-fuerza{% endif %}
                                 {% if 'potencia' in dia.entrenamiento.fase_css %}text-fase-potencia{% endif %}
                                 {% if 'descarga' in dia.entrenamiento.fase_css %}text-fase-descarga{% endif %}
                             {% endif %}"
                     {% if dia.entrenamiento %}onclick="mostrarDetalles('{{ dia.numero }}')" {% endif %}>

                    {{ dia.numero }}
                </div>
                {% else %}
                <div class="cyber-calendar-day empty"></div>
                {% endif %}
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Modal (sin cambios) -->
    <div class="modal fade cyber-modal" id="detalleEntrenamientoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body" id="modal-contenido-ejercicios"></div>
                <div class="modal-footer">
                    <button type="button" class="btn cyber-btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a href="#" id="btn-empezar-entreno" class="btn cyber-btn-success">Empezar Entrenamiento</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
{% block extra_js %}
<script>
    // Efectos adicionales de interactividad
    document.addEventListener('DOMContentLoaded', function() {
        // Efectos para días del calendario
        const calendarDays = document.querySelectorAll('.cyber-calendar-day:not(.empty)');
        calendarDays.forEach(day => {
            day.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
            });

            day.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // Efectos para entradas de entrenamiento
        const trainingEntries = document.querySelectorAll('.cyber-training-entry');
        trainingEntries.forEach(entry => {
            entry.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px) scale(1.02)';
            });

            entry.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // Efectos para botones de navegación
        const navBtns = document.querySelectorAll('.cyber-nav-btn');
        navBtns.forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
            });

            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });

    // Datos de entrenamientos (se debe proporcionar desde Django)
    const diasDeEntreno = {{ entrenos_por_fecha_data|safe }};

    function mostrarDetalles(dia) {
        const añoActual = {{ calendario.año }};
        const mesActual = String({{ calendario.mes_num }}).padStart(2, '0');
        const diaActual = String(dia).padStart(2, '0');
        const fechaSeleccionada = `${añoActual}-${mesActual}-${diaActual}`;

        const entrenamiento = diasDeEntreno[fechaSeleccionada];
        const modalElement = document.getElementById('detalleEntrenamientoModal');
        const modalBody = document.getElementById('modal-contenido-ejercicios');
        const btnEmpezar = document.getElementById('btn-empezar-entreno');

        if (entrenamiento) {
            let tableHtml = `
                <table class="w-full table-auto text-sm text-left text-white shadow-lg rounded-xl overflow-hidden">
            <thead class="bg-gradient-to-r from-[#31cff4] to-[#160f29] text-black uppercase text-xs tracking-wider">
            <tr>
                <th class="px-4 py-3">Nombre</th>
                <th class="px-4 py-3">Series</th>
                <th class="px-4 py-3">Rep</th>
                <th class="px-4 py-3">RPE</th>
                <th class="px-4 py-3">Exp</th>

            </tr>
            </thead>
                    <tbody class="bg-[#121212] divide-y divide-gray-700">
            `;

            entrenamiento.ejercicios.forEach(ej => {
                tableHtml += `
                    <tr class="hover:bg-[#1f1f1f] transition">
                        <td class="px-4 py-3 ">${ej.nombre.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                        <td class="px-4 py-3 text-cyan-400">${ej.series}</td>
                        <td class="px-4 py-3 font-bold text-yellow-300">${ej.repeticiones}</td>
                        <td class="px-4 py-3 font-bold text-green-400">${ej.rpe_objetivo}</td>
                        <td class="px-4 py-3 font-bold text-pink-400">--</td>

                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            modalBody.innerHTML = tableHtml;

            const url = "{% url 'entrenos:entrenamiento_activo' cliente.id %}";
            const params = new URLSearchParams({
                fecha: fechaSeleccionada,
                rutina_nombre: entrenamiento.nombre_rutina,
                ejercicios: JSON.stringify(entrenamiento.ejercicios)
            });
            btnEmpezar.href = `${url}?${params.toString()}`;
            btnEmpezar.style.display = 'inline-flex';

        } else {
            modalBody.innerHTML = `<div class="p-4 text-center text-muted">No hay entrenamiento programado para este día.</div>`;
            btnEmpezar.style.display = 'none';
        }

        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        // Efectos adicionales para el modal
        setTimeout(() => {
            const listItems = document.querySelectorAll('.cyber-list-group-item');
            listItems.forEach((item, index) => {
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                }, index * 100);
            });
        }, 100);
    }

    // Efectos de carga inicial
    window.addEventListener('load', function() {
        const calendarContainer = document.querySelector('.cyber-calendar-container');
        calendarContainer.classList.add('loading-calendar');

        setTimeout(() => {
            calendarContainer.classList.remove('loading-calendar');
        }, 1000);
    });
</script>
{% endblock %}

