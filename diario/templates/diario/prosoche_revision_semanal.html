{% extends 'diario/base_stoic.html' %}
{% load static %}

{% block title %}Revisi√≥n Semanal - Prosoche{% endblock %}

{% block extra_css %}
<style>
    .accordion-button:not(.collapsed) {
        color: var(--dark-color);
        background-color: rgba(0,0,0,0.03);
    }
    .explanation-box {
        background-color: rgba(var(--bs-info-rgb), 0.05);
        border-left: 4px solid rgba(var(--bs-info-rgb), 0.5);
        padding: 1rem;
        border-radius: .25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in-up">
    <!-- Encabezado -->
    <div class="card shadow-soft mb-4">
        <div class="card-body text-center p-4">
            <h1 class="text-gradient">Revisi√≥n Semanal Guiada</h1>
            <p class="lead text-muted">Reflexiona sobre el pasado, planifica el futuro.</p>
        </div>
    </div>

    <!-- UN √öNICO FORMULARIO PARA TODA LA P√ÅGINA -->
    <form method="POST">
        {% csrf_token %}
        <div class="row">
            <!-- Columna de Revisi√≥n (Paso 1) -->
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-history fa-2x text-info me-3"></i>
                        <div>
                            <h5 class="mb-0">Paso 1: Revisa tu Semana Pasada</h5>
                            <small class="text-muted">{{ inicio_semana_pasada|date:"d M" }} - {{ fin_semana_pasada|date:"d M Y" }}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if entradas_semana %}
                        <!-- Estad√≠sticas Clave -->
                        <div class="row text-center mb-4 g-3">
                            <div class="col">
                                <div class="stat-item p-2 border rounded">
                                    <div class="stat-number">{{ animo_promedio|default:"N/A" }}/5</div>
                                    <div class="stat-label">√Ånimo Prom.</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="stat-item p-2 border rounded">
                                    <div class="stat-number">{{ tareas_completadas }}/{{ total_tareas }}</div>
                                    <div class="stat-label">Tareas</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="stat-item p-2 border rounded">
                                    <div class="stat-number">{{ porcentaje_tareas }}%</div>
                                    <div class="stat-label">Productividad</div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de Entradas -->
                        <h6 class="text-muted">Tus Reflexiones Diarias:</h6>
                        <div class="accordion" id="acordeonSemana">
                            {% for entrada in entradas_semana %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ entrada.id }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ entrada.id }}">
                                        <strong>{{ entrada.fecha|date:"l, d M" }}</strong>
                                        <span class="ms-auto me-2">√Ånimo: {{ entrada.estado_animo }}/5</span>
                                    </button>
                                </h2>
                                <div id="collapse{{ entrada.id }}" class="accordion-collapse collapse" data-bs-parent="#acordeonSemana">
                                    <div class="accordion-body">
                                        <p class="mb-2"><strong>Persona que quise ser:</strong> <em class="text-muted">"{{ entrada.persona_quiero_ser|default:"-" }}"</em></p>
                                        <p class="mb-2"><strong>Algo bueno que pas√≥:</strong> <em class="text-muted">"{{ entrada.que_ha_ido_bien|default:"-" }}"</em></p>
                                        <p class="mb-0"><strong>Algo que puedo mejorar:</strong> <em class="text-muted">"{{ entrada.que_puedo_mejorar|default:"-" }}"</em></p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Formulario de Reflexi√≥n Semanal (Integrado) -->
                        <h6 class="text-muted mt-4">Tu Reflexi√≥n Semanal:</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold small"><i class="fas fa-trophy text-warning me-1"></i> Principal(es) logro(s) de la semana</label>
                            <textarea name="logro_principal" class="form-control form-control-sm" rows="3" placeholder="Basado en tus entradas, ¬øcu√°l fue tu mayor victoria?">{{ revision.logro_principal|default:'' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small"><i class="fas fa-mountain text-danger me-1"></i> Principal obst√°culo y c√≥mo lo gestionaste</label>
                            <textarea name="obstaculo_principal" class="form-control form-control-sm" rows="3" placeholder="¬øCu√°l fue el mayor desaf√≠o?">{{ revision.obstaculo_principal|default:'' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small"><i class="fas fa-lightbulb text-success me-1"></i> Principal aprendizaje</label>
                            <textarea name="aprendizaje_principal" class="form-control form-control-sm" rows="3" placeholder="¬øQu√© lecci√≥n te llevas de esta semana?">{{ revision.aprendizaje_principal|default:'' }}</textarea>
                        </div>

                        {% else %}
                        <div class="text-center p-4">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay suficientes datos de la semana pasada para realizar una revisi√≥n.</p>
                            <small class="text-muted">¬°Aseg√∫rate de registrar tus entradas diarias esta semana!</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Columna de Planificaci√≥n (Paso 2) -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-rocket fa-2x text-success me-3"></i>
                        <div>
                            <h5 class="mb-0">Paso 2: Planifica tu Pr√≥xima Semana</h5>
                            <small class="text-muted">Establece tus 3 objetivos m√°s importantes</small>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if semana_actual %}
                        <div class="explanation-box mb-4">
                            <h6 class="text-info"><i class="fas fa-sitemap me-2"></i>La Jerarqu√≠a de la Planificaci√≥n</h6>
                            <p class="small text-muted mb-2"><strong>La Visi√≥n (Objetivos Mensuales):</strong> Tu "Norte Estrat√©gico". Responden a: <em>"¬øQu√© quiero haber logrado cuando termine este mes?"</em></p>
                            <p class="small text-muted mb-0"><strong>La T√°ctica (Objetivos Semanales):</strong> Tus "Pasos Concretos". Responden a: <em>"¬øQu√© 3 cosas debo hacer **esta semana** para acercarme a mis metas mensuales?"</em></p>
                        </div>

                        <!-- === L√çNEA CORREGIDA === -->
                        {% if prosoche_mes_actual and prosoche_mes_actual.objetivo_principal_1 or prosoche_mes_actual.objetivo_principal_2 or prosoche_mes_actual.objetivo_principal_3 %}
                        <div class="p-3 mb-4 rounded" style="background-color: rgba(var(--bs-primary-rgb), 0.05); border: 1px solid rgba(var(--bs-primary-rgb), 0.2);">
                            <h6 class="text-muted"><i class="fas fa-bullseye"></i> Recordatorio de tus Objetivos Mensuales:</h6>
                            <ul class="list-unstyled mb-0 small">
                                {% if prosoche_mes_actual.objetivo_principal_1 %}
                                <li>1. {{ prosoche_mes_actual.objetivo_principal_1 }}</li>
                                {% endif %}
                                {% if prosoche_mes_actual.objetivo_principal_2 %}
                                <li>2. {{ prosoche_mes_actual.objetivo_principal_2 }}</li>
                                {% endif %}
                                {% if prosoche_mes_actual.objetivo_principal_3 %}
                                <li>3. {{ prosoche_mes_actual.objetivo_principal_3 }}</li>
                                {% endif %}
                            </ul>
                        </div>
                        {% endif %}

                        <p class="text-muted small">Alinea estos objetivos con tus metas mensuales. ¬øQu√© tres cosas te acercar√°n m√°s a donde quieres estar?</p>

                        <div class="mb-3">
                            <label for="objetivo_1" class="form-label fw-bold">üéØ Objetivo Clave 1</label>
                            <input type="text" class="form-control" id="objetivo_1" name="objetivo_1" value="{{ semana_actual.objetivo_1|default:'' }}" placeholder="Ej: Completar el informe del proyecto X">
                        </div>
                        <div class="mb-3">
                            <label for="objetivo_2" class="form-label fw-bold">üéØ Objetivo Clave 2</label>
                            <input type="text" class="form-control" id="objetivo_2" name="objetivo_2" value="{{ semana_actual.objetivo_2|default:'' }}" placeholder="Ej: Hacer ejercicio 3 veces esta semana">
                        </div>
                        <div class="mb-3">
                            <label for="objetivo_3" class="form-label fw-bold">üéØ Objetivo Clave 3</label>
                            <input type="text" class="form-control" id="objetivo_3" name="objetivo_3" value="{{ semana_actual.objetivo_3|default:'' }}" placeholder="Ej: Llamar a un viejo amigo">
                        </div>

                        {% else %}
                        <div class="alert alert-danger">
                            <strong>Error:</strong> No se ha podido inicializar el mes actual. Ve al <a href="{% url 'diario:prosoche_dashboard' %}" class="alert-link">dashboard de Prosoche</a> para crearlo.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- En diario/templates/diario/prosoche_revision_semanal.html -->

        <!-- ... (despu√©s del bloque de estad√≠sticas de √Ånimo/Tareas/Productividad) ... -->

        <!-- ================================================== -->
        <!-- INICIO: NUEVO PANEL DE AN√ÅLISIS DE SIMBIOSIS -->
        <!-- ================================================== -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-users me-2 text-info"></i>Tu Semana Social</h6>
            </div>
            <div class="card-body">
                {% if interacciones_semana %}
                <div class="row text-center g-3">
                    <div class="col">
                        <div class="stat-item p-2 border rounded">
                            <div class="stat-number">{{ interacciones_semana|length }}</div>
                            <div class="stat-label">Interacciones</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="stat-item p-2 border rounded">
                            <div class="stat-number text-success">{{ balance_interacciones.positiva|default:0 }}</div>
                            <div class="stat-label">Positivas</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="stat-item p-2 border rounded">
                            <div class="stat-number text-danger">{{ balance_interacciones.conflicto|default:0 }}</div>
                            <div class="stat-label">Conflictos</div>
                        </div>
                    </div>
                </div>
                {% if persona_mas_frecuente %}
                <div class="mt-3 text-center">
                    <small class="text-muted">Persona clave de la semana:</small>
                    <p class="fw-bold mb-0">
                        <a href="{% url 'diario:persona_detalle' persona_mas_frecuente.persona.id %}">
                            {{ persona_mas_frecuente.persona.nombre }}
                        </a>
                        <span class="badge bg-secondary rounded-pill ms-1">{{ persona_mas_frecuente.count }}</span>
                    </p>
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted small text-center mb-0">No registraste interacciones significativas la semana pasada.</p>
                {% endif %}
            </div>
        </div>
        <!-- ================================================== -->
        <!-- FIN: NUEVO PANEL DE AN√ÅLISIS DE SIMBIOSIS -->
        <!-- ================================================== -->

        <!-- Bot√≥n de Guardado √önico -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg shadow-soft px-5 py-3">
                    <i class="fas fa-check-double me-2"></i>Finalizar Revisi√≥n y Guardar Todo
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}
